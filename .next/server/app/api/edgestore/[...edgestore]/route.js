(()=>{var e={};e.id=8683,e.ids=[8683],e.modules={5662:()=>{},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19116:(e,t,r)=>{"use strict";let i,a,n;r.r(t),r.d(t,{patchFetch:()=>t5,routeModule:()=>t2,serverHooks:()=>t6,workAsyncStorage:()=>t8,workUnitAsyncStorage:()=>t4});var o={};r.r(o),r.d(o,{GET:()=>t1,POST:()=>t1});var s=r(19678),c=r(81303),l=r(46862),d=r(51201);function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let u={BAD_REQUEST:400,FILE_TOO_LARGE:400,MIME_TYPE_NOT_ALLOWED:400,UNAUTHORIZED:401,UPLOAD_NOT_ALLOWED:403,DELETE_NOT_ALLOWED:403,CREATE_CONTEXT_ERROR:500,SERVER_ERROR:500};class h extends Error{formattedMessage(){return`${this.message}${this.details?`
    Details: ${JSON.stringify(this.details)}`:""}${this.cause?`
    Caused by: ${this.cause.message}`:""}`}formattedJson(){return{message:"SERVER_ERROR"===this.code?"Internal server error":this.message,code:this.code,details:this.details}}constructor(e){super(e.message),p(this,"cause",void 0),p(this,"code",void 0),p(this,"level",void 0),p(this,"details",void 0),this.name="EdgeStoreError",this.code=e.code,this.cause=e.cause,this.level=u[e.code]>=500?"error":"warn",this.details="details"in e?e.details:void 0}}let f=(e,t)=>{let r={...e,...t};return y({type:r.type},r)};function y(e,t){let r={type:e.type,input:d.z.never(),path:[],metadata:()=>({}),...t};return{$config:{ctx:void 0},_def:r,input:e=>f(r,{input:e}),path:e=>f(r,{path:e(function(){let e=(t,r)=>new Proxy(()=>t,{get:(r,i)=>e(`${t}.${String(i)}`)});return new Proxy(()=>"",{get:(t,r)=>e(String(r))})}())}),metadata:e=>f(r,{metadata:e}),accessControl:e=>f(r,{accessControl:e}),beforeUpload:e=>f(r,{beforeUpload:e}),beforeDelete:e=>f(r,{beforeDelete:e})}}class m{context(){return new m}create(){return{imageBucket:e=>w("IMAGE",e),fileBucket:e=>w("FILE",e),router:function(e){return{$config:{ctx:void 0},buckets:e}}}}}function w(e,t){return y({type:e},{bucketConfig:t})}let g=new m,E=["debug","info","warn","error","none"];class b{shouldLog(e){return E.indexOf(e)>=E.indexOf(this.logLevel)}debug(e,...t){this.shouldLog("debug")&&console.debug("[EdgeStoreDebug]",e,...t)}info(e,...t){this.shouldLog("info")&&console.info("[EdgeStoreInfo]",e,...t)}warn(e,...t){this.shouldLog("warn")&&console.warn("[EdgeStoreWarn]",e,...t)}error(e,...t){this.shouldLog("error")&&console.error("[EdgeStoreError]",e,...t)}constructor(e){!function(e,t,r){t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r}(this,"logLevel",void 0),this.logLevel=e??"error"}}function _(e,t){return RegExp(`${t}/?(\\?.*)?$`).test(e)}let A=`Missing EDGE_STORE_ACCESS_KEY or EDGE_STORE_SECRET_KEY. 
This can happen if you are trying to import something related to the backend of Edge Store in a client component.`;class S extends Error{constructor(e=A){super(e),this.name="EdgeStoreCredentialsError"}}let v=process.env.EDGE_STORE_API_ENDPOINT??"https://api.edgestore.dev";async function T(e){let{body:t,accessKey:r,secretKey:i,path:a}=e,n=await fetch(`${v}${a}`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json",Authorization:`Basic ${Buffer.from(`${r}:${i}`).toString("base64")}`}});if(!n.ok)throw Error(`Failed to make request to ${a}: ${await n.text()}`);return await n.json()}let R={async getToken(e){let t=Object.entries(e.router.buckets).reduce((e,[t,r])=>(e[t]={path:r._def.path.map(e=>{let t=Object.entries(e);if(void 0===t[0])throw new h({message:`Empty path param found in: ${JSON.stringify(r._def.path)}`,code:"SERVER_ERROR"});let[i,a]=t[0];return{key:i,value:a()}}),accessControl:r._def.accessControl},e),{}),{token:r}=await T({body:{ctx:e.ctx,buckets:t},accessKey:e.accessKey,secretKey:e.secretKey,path:"/get-token"});return r},getFile:async({accessKey:e,secretKey:t,url:r})=>await T({path:"/get-file",accessKey:e,secretKey:t,body:{url:r}}),async requestUpload({accessKey:e,secretKey:t,bucketName:r,bucketType:i,fileInfo:a,multipart:n}){let o=await T({path:"/request-upload",accessKey:e,secretKey:t,body:{multipart:n,bucketName:r,bucketType:i,isPublic:a.isPublic,path:a.path,extension:a.extension,size:a.size,mimeType:a.type,metadata:a.metadata,fileName:a.fileName,replaceTargetUrl:a.replaceTargetUrl,isTemporary:a.temporary}});return{multipart:o.multipart,signedUrl:o.signedUrl,accessUrl:o.url,path:o.path,thumbnailUrl:o.thumbnailUrl}},requestUploadParts:async({accessKey:e,secretKey:t,key:r,multipart:i})=>({multipart:(await T({path:"/request-upload-parts",accessKey:e,secretKey:t,body:{multipart:i,key:r}})).multipart}),completeMultipartUpload:async({accessKey:e,secretKey:t,uploadId:r,key:i,parts:a})=>await T({path:"/complete-multipart-upload",accessKey:e,secretKey:t,body:{uploadId:r,key:i,parts:a}}),confirmUpload:async({accessKey:e,secretKey:t,url:r})=>await T({path:"/confirm-upload",accessKey:e,secretKey:t,body:{url:r}}),deleteFile:async({accessKey:e,secretKey:t,url:r})=>await T({path:"/delete-file",accessKey:e,secretKey:t,body:{url:r}}),listFiles:async({accessKey:e,secretKey:t,bucketName:r,filter:i,pagination:a})=>await T({path:"/list-files",accessKey:e,secretKey:t,body:{bucketName:r,filter:i,pagination:a}})},k=require("crypto");var C=r.n(k);let O=(e,t,r,i,a)=>{let n=parseInt(e.substr(3),10)>>3||20,o=(0,k.createHmac)(e,r.byteLength?r:new Uint8Array(n)).update(t).digest(),s=Math.ceil(a/n),c=new Uint8Array(n*s+i.byteLength+1),l=0,d=0;for(let t=1;t<=s;t++)c.set(i,d),c[d+i.byteLength]=t,c.set((0,k.createHmac)(e,o).update(c.subarray(l,d+i.byteLength+1)).digest(),d),l=d,d+=n;return c.slice(0,a)};"function"!=typeof k.hkdf||process.versions.electron||(i=async(...e)=>new Promise((t,r)=>{k.hkdf(...e,(e,i)=>{e?r(e):t(new Uint8Array(i))})}));let U=async(e,t,r,a,n)=>(i||O)(e,t,r,a,n);function x(e,t){if("string"==typeof e)return new TextEncoder().encode(e);if(!(e instanceof Uint8Array))throw TypeError(`"${t}"" must be an instance of Uint8Array or a string`);return e}async function P(e,t,r,i,a){return U(function(e){switch(e){case"sha256":case"sha384":case"sha512":case"sha1":return e;default:throw TypeError('unsupported "digest" value')}}(e),function(e){let t=x(e,"ikm");if(!t.byteLength)throw TypeError('"ikm" must be at least one byte in length');return t}(t),x(r,"salt"),function(e){let t=x(e,"info");if(t.byteLength>1024)throw TypeError('"info" must not contain more than 1024 bytes');return t}(i),function(e,t){if("number"!=typeof e||!Number.isInteger(e)||e<1)throw TypeError('"keylen" must be a positive integer');if(e>255*(parseInt(t.substr(3),10)>>3||20))throw TypeError('"keylen" too large');return e}(a,e))}var H=r(93807);let K=require("buffer"),I=(e,t)=>(0,k.createHash)(e).update(t).digest(),D=new TextEncoder,W=new TextDecoder;function B(...e){let t=new Uint8Array(e.reduce((e,{length:t})=>e+t,0)),r=0;return e.forEach(e=>{t.set(e,r),r+=e.length}),t}function M(e,t){return B(D.encode(e),new Uint8Array([0]),t)}function J(e,t,r){if(t<0||t>=0x100000000)throw RangeError(`value must be >= 0 and <= ${0x100000000-1}. Received ${t}`);e.set([t>>>24,t>>>16,t>>>8,255&t],r)}function $(e){let t=new Uint8Array(4);return J(t,e),t}function j(e){return B($(e.length),e)}async function L(e,t,r){let i=Math.ceil((t>>3)/32),a=new Uint8Array(32*i);for(let t=0;t<i;t++){let i=new Uint8Array(4+e.length+r.length);i.set($(t+1)),i.set(e,4),i.set(r,4+e.length),a.set(await I("sha256",i),32*t)}return a.slice(0,t>>3)}a=K.Buffer.isEncoding("base64url")?e=>K.Buffer.from(e).toString("base64url"):e=>K.Buffer.from(e).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");let G=e=>K.Buffer.from(function(e){let t=e;return t instanceof Uint8Array&&(t=W.decode(t)),t}(e),"base64");class N extends Error{static get code(){return"ERR_JOSE_GENERIC"}constructor(e){var t;super(e),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,null==(t=Error.captureStackTrace)||t.call(Error,this,this.constructor)}}class F extends N{static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=t,this.reason=r}}class z extends N{static get code(){return"ERR_JWT_EXPIRED"}constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_EXPIRED",this.claim=t,this.reason=r}}class q extends N{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class V extends N{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class Y extends N{constructor(){super(...arguments),this.code="ERR_JWE_DECRYPTION_FAILED",this.message="decryption operation failed"}static get code(){return"ERR_JWE_DECRYPTION_FAILED"}}class X extends N{constructor(){super(...arguments),this.code="ERR_JWE_DECOMPRESSION_FAILED",this.message="decompression operation failed"}static get code(){return"ERR_JWE_DECOMPRESSION_FAILED"}}class Q extends N{constructor(){super(...arguments),this.code="ERR_JWE_INVALID"}static get code(){return"ERR_JWE_INVALID"}}class Z extends N{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}function ee(e){switch(e){case"A128GCM":case"A128GCMKW":case"A192GCM":case"A192GCMKW":case"A256GCM":case"A256GCMKW":return 96;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return 128;default:throw new V(`Unsupported JWE Algorithm: ${e}`)}}Symbol.asyncIterator;let et=e=>(0,k.randomFillSync)(new Uint8Array(ee(e)>>3)),er=(e,t)=>{if(t.length<<3!==ee(e))throw new Q("Invalid Initialization Vector length")},ei=require("util"),ea=ei.types.isKeyObject?e=>ei.types.isKeyObject(e):e=>null!=e&&e instanceof k.KeyObject,en=(e,t)=>{let r;switch(e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":r=parseInt(e.slice(-3),10);break;case"A128GCM":case"A192GCM":case"A256GCM":r=parseInt(e.slice(1,4),10);break;default:throw new V(`Content Encryption Algorithm ${e} is not supported either by JOSE or your javascript runtime`)}if(t instanceof Uint8Array){let e=t.byteLength<<3;if(e!==r)throw new Q(`Invalid Content Encryption Key length. Expected ${r} bits, got ${e} bits`);return}if(ea(t)&&"secret"===t.type){let e=t.symmetricKeySize<<3;if(e!==r)throw new Q(`Invalid Content Encryption Key length. Expected ${r} bits, got ${e} bits`);return}throw TypeError("Invalid Content Encryption Key type")};function eo(e,t,r,i,a,n){let o=B(e,t,r,function(e){let t=Math.floor(e/0x100000000),r=new Uint8Array(8);return J(r,t,0),J(r,e%0x100000000,4),r}(e.length<<3)),s=(0,k.createHmac)(`sha${i}`,a);return s.update(o),s.digest().slice(0,n>>3)}let es=k.webcrypto,ec=ei.types.isCryptoKey?e=>ei.types.isCryptoKey(e):e=>!1;function el(e,t="algorithm.name"){return TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function ed(e,t){return e.name===t}function ep(e,t,...r){switch(t){case"A128GCM":case"A192GCM":case"A256GCM":{if(!ed(e.algorithm,"AES-GCM"))throw el("AES-GCM");let r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw el(r,"algorithm.length");break}case"A128KW":case"A192KW":case"A256KW":{if(!ed(e.algorithm,"AES-KW"))throw el("AES-KW");let r=parseInt(t.slice(1,4),10);if(e.algorithm.length!==r)throw el(r,"algorithm.length");break}case"ECDH":switch(e.algorithm.name){case"ECDH":case"X25519":case"X448":break;default:throw el("ECDH, X25519, or X448")}break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":if(!ed(e.algorithm,"PBKDF2"))throw el("PBKDF2");break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":{if(!ed(e.algorithm,"RSA-OAEP"))throw el("RSA-OAEP");let r=parseInt(t.slice(9),10)||1;if(parseInt(e.algorithm.hash.name.slice(4),10)!==r)throw el(`SHA-${r}`,"algorithm.hash");break}default:throw TypeError("CryptoKey does not support this operation")}var i=e,a=r;if(a.length&&!a.some(e=>i.usages.includes(e))){let e="CryptoKey does not support this operation, its usages must include ";if(a.length>2){let t=a.pop();e+=`one of ${a.join(", ")}, or ${t}.`}else 2===a.length?e+=`one of ${a[0]} or ${a[1]}.`:e+=`${a[0]}.`;throw TypeError(e)}}function eu(e,t,...r){if(r.length>2){let t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor&&t.constructor.name&&(e+=` Received an instance of ${t.constructor.name}`),e}let eh=(e,...t)=>eu("Key must be ",e,...t);function ef(e,t,...r){return eu(`Key for the ${e} algorithm must be `,t,...r)}let ey=e=>(n||(n=new Set((0,k.getCiphers)())),n.has(e)),em=e=>ea(e)||ec(e),ew=["KeyObject"];(globalThis.CryptoKey||(null==es?void 0:es.CryptoKey))&&ew.push("CryptoKey");let eg=(e,t,r,i,a)=>{let n;if(ec(r))ep(r,e,"encrypt"),n=k.KeyObject.from(r);else if(r instanceof Uint8Array||ea(r))n=r;else throw TypeError(eh(r,...ew,"Uint8Array"));switch(en(e,n),er(e,i),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return function(e,t,r,i,a){let n=parseInt(e.slice(1,4),10);ea(r)&&(r=r.export());let o=r.subarray(n>>3),s=r.subarray(0,n>>3),c=`aes-${n}-cbc`;if(!ey(c))throw new V(`alg ${e} is not supported by your javascript runtime`);let l=(0,k.createCipheriv)(c,o,i),d=B(l.update(t),l.final()),p=eo(a,i,d,parseInt(e.slice(-3),10),s,n);return{ciphertext:d,tag:p}}(e,t,n,i,a);case"A128GCM":case"A192GCM":case"A256GCM":return function(e,t,r,i,a){let n=parseInt(e.slice(1,4),10),o=`aes-${n}-gcm`;if(!ey(o))throw new V(`alg ${e} is not supported by your javascript runtime`);let s=(0,k.createCipheriv)(o,r,i,{authTagLength:16});a.byteLength&&s.setAAD(a,{plaintextLength:t.length});let c=s.update(t);return s.final(),{ciphertext:c,tag:s.getAuthTag()}}(e,t,n,i,a);default:throw new V("Unsupported JWE Content Encryption Algorithm")}};var eE=r(74075);let eb=(0,ei.promisify)(eE.inflateRaw),e_=(0,ei.promisify)(eE.deflateRaw),eA=e=>eb(e,{maxOutputLength:25e4}).catch(()=>{throw new X}),eS=e=>e_(e);function ev(e,t){if(e.symmetricKeySize<<3!==parseInt(t.slice(1,4),10))throw TypeError(`Invalid key size for alg: ${t}`)}function eT(e,t,r){if(ea(e))return e;if(e instanceof Uint8Array)return(0,k.createSecretKey)(e);if(ec(e))return ep(e,t,r),k.KeyObject.from(e);throw TypeError(eh(e,...ew,"Uint8Array"))}let eR=(e,t,r)=>{let i=parseInt(e.slice(1,4),10),a=`aes${i}-wrap`;if(!ey(a))throw new V(`alg ${e} is not supported either by JOSE or your javascript runtime`);let n=eT(t,e,"wrapKey");ev(n,e);let o=(0,k.createCipheriv)(a,n,K.Buffer.alloc(8,166));return B(o.update(r),o.final())},ek=(e,t,r)=>{let i=parseInt(e.slice(1,4),10),a=`aes${i}-wrap`;if(!ey(a))throw new V(`alg ${e} is not supported either by JOSE or your javascript runtime`);let n=eT(t,e,"unwrapKey");ev(n,e);let o=(0,k.createDecipheriv)(a,n,K.Buffer.alloc(8,166));return B(o.update(r),o.final())},eC=K.Buffer.from([42,134,72,206,61,3,1,7]),eO=K.Buffer.from([43,129,4,0,34]),eU=K.Buffer.from([43,129,4,0,35]),ex=K.Buffer.from([43,129,4,0,10]),eP=new WeakMap,eH=e=>{switch(e){case"prime256v1":return"P-256";case"secp384r1":return"P-384";case"secp521r1":return"P-521";case"secp256k1":return"secp256k1";default:throw new V("Unsupported key curve for this operation")}},eK=(e,t)=>{var r;let i;if(ec(e))i=k.KeyObject.from(e);else if(ea(e))i=e;else throw TypeError(eh(e,...ew));if("secret"===i.type)throw TypeError('only "private" or "public" type keys can be used for this operation');switch(i.asymmetricKeyType){case"ed25519":case"ed448":return`Ed${i.asymmetricKeyType.slice(2)}`;case"x25519":case"x448":return`X${i.asymmetricKeyType.slice(1)}`;case"ec":{if(eP.has(i))return eP.get(i);let e=null==(r=i.asymmetricKeyDetails)?void 0:r.namedCurve;if(e||"private"!==i.type){if(!e){let t=i.export({format:"der",type:"spki"}),r=t[1]<128?14:15,a=t[r],n=t.slice(r+1,r+1+a);if(n.equals(eC))e="prime256v1";else if(n.equals(eO))e="secp384r1";else if(n.equals(eU))e="secp521r1";else if(n.equals(ex))e="secp256k1";else throw new V("Unsupported key curve for this operation")}}else e=eK((0,k.createPublicKey)(i),!0);if(t)return e;let a=eH(e);return eP.set(i,a),a}default:throw TypeError("Invalid asymmetric key type for this operation")}},eI=(0,ei.promisify)(k.generateKeyPair);async function eD(e,t,r,i,a=new Uint8Array(0),n=new Uint8Array(0)){let o,s;if(ec(e))ep(e,"ECDH"),o=k.KeyObject.from(e);else if(ea(e))o=e;else throw TypeError(eh(e,...ew));if(ec(t))ep(t,"ECDH","deriveBits"),s=k.KeyObject.from(t);else if(ea(t))s=t;else throw TypeError(eh(t,...ew));let c=B(j(D.encode(r)),j(a),j(n),$(i));return L((0,k.diffieHellman)({privateKey:s,publicKey:o}),i,c)}async function eW(e){let t;if(ec(e))t=k.KeyObject.from(e);else if(ea(e))t=e;else throw TypeError(eh(e,...ew));switch(t.asymmetricKeyType){case"x25519":return eI("x25519");case"x448":return eI("x448");case"ec":return eI("ec",{namedCurve:eK(t)});default:throw new V("Invalid or unsupported EPK")}}let eB=e=>["P-256","P-384","P-521","X25519","X448"].includes(eK(e));function eM(e){if(!(e instanceof Uint8Array)||e.length<8)throw new Q("PBES2 Salt Input must be 8 or more octets")}let eJ=(0,ei.promisify)(k.pbkdf2);function e$(e,t){if(ea(e))return e.export();if(e instanceof Uint8Array)return e;if(ec(e))return ep(e,t,"deriveBits","deriveKey"),k.KeyObject.from(e).export();throw TypeError(eh(e,...ew,"Uint8Array"))}let ej=async(e,t,r,i=2048,n=(0,k.randomFillSync)(new Uint8Array(16)))=>{eM(n);let o=M(e,n),s=parseInt(e.slice(13,16),10)>>3,c=e$(t,e),l=await eJ(c,o,i,s,`sha${e.slice(8,11)}`);return{encryptedKey:await eR(e.slice(-6),l,r),p2c:i,p2s:a(n)}},eL=async(e,t,r,i,a)=>{eM(a);let n=M(e,a),o=parseInt(e.slice(13,16),10)>>3,s=e$(t,e),c=await eJ(s,n,i,o,`sha${e.slice(8,11)}`);return ek(e.slice(-6),c,r)},eG=new WeakMap,eN=(e,t)=>{let r=e.readUInt8(1);if((128&r)==0)return 0===t?r:eN(e.subarray(2+r),t-1);let i=127&r;r=0;for(let t=0;t<i;t++)r<<=8,r|=e.readUInt8(2+t);return 0===t?r:eN(e.subarray(2+r),t-1)},eF=(e,t)=>{let r=e.readUInt8(1);return(128&r)==0?eN(e.subarray(2),t):eN(e.subarray(2+(127&r)),t)},ez=e=>{var t,r;if(eG.has(e))return eG.get(e);let i=null!=(r=null==(t=e.asymmetricKeyDetails)?void 0:t.modulusLength)?r:eF(e.export({format:"der",type:"pkcs1"}),+("private"===e.type))-1<<3;return eG.set(e,i),i},eq=(e,t)=>{eG.set(e,t)},eV=(e,t)=>{if(2048>ez(e))throw TypeError(`${t} requires key modulusLength to be 2048 bits or larger`)},eY=(e,t)=>{if("rsa"!==e.asymmetricKeyType)throw TypeError("Invalid key for this operation, its asymmetricKeyType must be rsa");eV(e,t)},eX=e=>{switch(e){case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":return k.constants.RSA_PKCS1_OAEP_PADDING;case"RSA1_5":return k.constants.RSA_PKCS1_PADDING;default:return}},eQ=e=>{switch(e){case"RSA-OAEP":return"sha1";case"RSA-OAEP-256":return"sha256";case"RSA-OAEP-384":return"sha384";case"RSA-OAEP-512":return"sha512";default:return}};function eZ(e,t,...r){if(ea(e))return e;if(ec(e))return ep(e,t,...r),k.KeyObject.from(e);throw TypeError(eh(e,...ew))}let e0=(e,t,r)=>{let i=eX(e),a=eQ(e),n=eZ(t,e,"wrapKey","encrypt");return eY(n,e),(0,k.publicEncrypt)({key:n,oaepHash:a,padding:i},r)},e1=(e,t,r)=>{let i=eX(e),a=eQ(e),n=eZ(t,e,"unwrapKey","decrypt");return eY(n,e),(0,k.privateDecrypt)({key:n,oaepHash:a,padding:i},r)};function e2(e){switch(e){case"A128GCM":return 128;case"A192GCM":return 192;case"A256GCM":case"A128CBC-HS256":return 256;case"A192CBC-HS384":return 384;case"A256CBC-HS512":return 512;default:throw new V(`Unsupported JWE Algorithm: ${e}`)}}let e8=e=>(0,k.randomFillSync)(new Uint8Array(e2(e)>>3));class e4{constructor(e){if(48!==e[0]||(this.buffer=e,this.offset=1,this.decodeLength()!==e.length-this.offset))throw TypeError()}decodeLength(){let e=this.buffer[this.offset++];if(128&e){let t=-129&e;e=0;for(let r=0;r<t;r++)e=e<<8|this.buffer[this.offset+r];this.offset+=t}return e}unsignedInteger(){if(2!==this.buffer[this.offset++])throw TypeError();let e=this.decodeLength();0===this.buffer[this.offset]&&(this.offset++,e--);let t=this.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}end(){if(this.offset!==this.buffer.length)throw TypeError()}}let[e6,e5]=process.versions.node.split(".").map(e=>parseInt(e,10));process.versions;let e3=e6>=16||15===e6&&e5>=9,e9=e6>=16||15===e6&&e5>=12,e7=e=>{let t;if(ec(e)){if(!e.extractable)throw TypeError("CryptoKey is not extractable");t=k.KeyObject.from(e)}else if(ea(e))t=e;else if(e instanceof Uint8Array)return{kty:"oct",k:a(e)};else throw TypeError(eh(e,...ew,"Uint8Array"));if(e3){if("secret"!==t.type&&!["rsa","ec","ed25519","x25519","ed448","x448"].includes(t.asymmetricKeyType))throw new V("Unsupported key asymmetricKeyType");return t.export({format:"jwk"})}switch(t.type){case"secret":return{kty:"oct",k:a(t.export())};case"private":case"public":switch(t.asymmetricKeyType){case"rsa":{let e,r=new e4(t.export({format:"der",type:"pkcs1"}));"private"===t.type&&r.unsignedInteger();let i=a(r.unsignedInteger()),n=a(r.unsignedInteger());return"private"===t.type&&(e={d:a(r.unsignedInteger()),p:a(r.unsignedInteger()),q:a(r.unsignedInteger()),dp:a(r.unsignedInteger()),dq:a(r.unsignedInteger()),qi:a(r.unsignedInteger())}),r.end(),{kty:"RSA",n:i,e:n,...e}}case"ec":{let e,r,i,n=eK(t);switch(n){case"secp256k1":e=64,r=33,i=-1;break;case"P-256":e=64,r=36,i=-1;break;case"P-384":e=96,r=35,i=-3;break;case"P-521":e=132,r=35,i=-3;break;default:throw new V("Unsupported curve")}if("public"===t.type){let r=t.export({type:"spki",format:"der"});return{kty:"EC",crv:n,x:a(r.subarray(-e,-e/2)),y:a(r.subarray(-e/2))}}let o=t.export({type:"pkcs8",format:"der"});return o.length<100&&(r+=i),{...e7((0,k.createPublicKey)(t)),d:a(o.subarray(r,r+e/2))}}case"ed25519":case"x25519":{let e=eK(t);if("public"===t.type)return{kty:"OKP",crv:e,x:a(t.export({type:"spki",format:"der"}).subarray(-32))};let r=t.export({type:"pkcs8",format:"der"});return{...e7((0,k.createPublicKey)(t)),d:a(r.subarray(-32))}}case"ed448":case"x448":{let e=eK(t);if("public"===t.type)return{kty:"OKP",crv:e,x:a(t.export({type:"spki",format:"der"}).subarray("Ed448"===e?-57:-56))};let r=t.export({type:"pkcs8",format:"der"});return{...e7((0,k.createPublicKey)(t)),d:a(r.subarray("Ed448"===e?-57:-56))}}default:throw new V("Unsupported key asymmetricKeyType")}default:throw new V("Unsupported key type")}};async function te(e){return e7(e)}let tt=(e,t)=>{if(!(t instanceof Uint8Array)){if(!em(t))throw TypeError(ef(e,t,...ew,"Uint8Array"));if("secret"!==t.type)throw TypeError(`${ew.join(" or ")} instances for symmetric algorithms must be of type "secret"`)}},tr=(e,t,r)=>{if(!em(t))throw TypeError(ef(e,t,...ew));if("secret"===t.type)throw TypeError(`${ew.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if("sign"===r&&"public"===t.type)throw TypeError(`${ew.join(" or ")} instances for asymmetric algorithm signing must be of type "private"`);if("decrypt"===r&&"public"===t.type)throw TypeError(`${ew.join(" or ")} instances for asymmetric algorithm decryption must be of type "private"`);if(t.algorithm&&"verify"===r&&"private"===t.type)throw TypeError(`${ew.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);if(t.algorithm&&"encrypt"===r&&"private"===t.type)throw TypeError(`${ew.join(" or ")} instances for asymmetric algorithm encryption must be of type "public"`)},ti=(e,t,r)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?tt(e,t):tr(e,t,r)},ta=k.timingSafeEqual,tn=(e,t,r,i,a,n)=>{let o;if(ec(t))ep(t,e,"decrypt"),o=k.KeyObject.from(t);else if(t instanceof Uint8Array||ea(t))o=t;else throw TypeError(eh(t,...ew,"Uint8Array"));switch(en(e,o),er(e,i),e){case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":return function(e,t,r,i,a,n){let o,s,c=parseInt(e.slice(1,4),10);ea(t)&&(t=t.export());let l=t.subarray(c>>3),d=t.subarray(0,c>>3),p=parseInt(e.slice(-3),10),u=`aes-${c}-cbc`;if(!ey(u))throw new V(`alg ${e} is not supported by your javascript runtime`);let h=eo(n,i,r,p,d,c);try{o=ta(a,h)}catch{}if(!o)throw new Y;try{let e=(0,k.createDecipheriv)(u,l,i);s=B(e.update(r),e.final())}catch{}if(!s)throw new Y;return s}(e,o,r,i,a,n);case"A128GCM":case"A192GCM":case"A256GCM":return function(e,t,r,i,a,n){let o=parseInt(e.slice(1,4),10),s=`aes-${o}-gcm`;if(!ey(s))throw new V(`alg ${e} is not supported by your javascript runtime`);try{let e=(0,k.createDecipheriv)(s,t,i,{authTagLength:16});e.setAuthTag(a),n.byteLength&&e.setAAD(n,{plaintextLength:r.length});let o=e.update(r);return e.final(),o}catch{throw new Y}}(e,o,r,i,a,n);default:throw new V("Unsupported JWE Content Encryption Algorithm")}};async function to(e,t,r,i){let n=e.slice(0,7);i||(i=et(n));let{ciphertext:o,tag:s}=await eg(n,r,t,i,new Uint8Array(0));return{encryptedKey:o,iv:a(i),tag:a(s)}}async function ts(e,t,r,i,a){return tn(e.slice(0,7),t,r,i,a,new Uint8Array(0))}async function tc(e,t,r,i,n={}){let o,s,c;switch(ti(e,r,"encrypt"),e){case"dir":c=r;break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{if(!eB(r))throw new V("ECDH with the provided key is not allowed or not supported by your javascript runtime");let{apu:l,apv:d}=n,{epk:p}=n;p||(p=(await eW(r)).privateKey);let{x:u,y:h,crv:f,kty:y}=await te(p),m=await eD(r,p,"ECDH-ES"===e?t:e,"ECDH-ES"===e?e2(t):parseInt(e.slice(-5,-2),10),l,d);if(s={epk:{x:u,crv:f,kty:y}},"EC"===y&&(s.epk.y=h),l&&(s.apu=a(l)),d&&(s.apv=a(d)),"ECDH-ES"===e){c=m;break}c=i||e8(t);let w=e.slice(-6);o=await eR(w,m,c);break}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":c=i||e8(t),o=await e0(e,r,c);break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{c=i||e8(t);let{p2c:a,p2s:l}=n;({encryptedKey:o,...s}=await ej(e,r,c,a,l));break}case"A128KW":case"A192KW":case"A256KW":c=i||e8(t),o=await eR(e,r,c);break;case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{c=i||e8(t);let{iv:a}=n;({encryptedKey:o,...s}=await to(e,r,c,a));break}default:throw new V('Invalid or unsupported "alg" (JWE Algorithm) header value')}return{cek:c,encryptedKey:o,parameters:s}}let tl=(...e)=>{let t,r=e.filter(Boolean);if(0===r.length||1===r.length)return!0;for(let e of r){let r=Object.keys(e);if(!t||0===t.size){t=new Set(r);continue}for(let e of r){if(t.has(e))return!1;t.add(e)}}return!0},td=function(e,t,r,i,a){let n;if(void 0!==a.crit&&void 0===i.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!i||void 0===i.crit)return new Set;if(!Array.isArray(i.crit)||0===i.crit.length||i.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');for(let o of(n=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t,i.crit)){if(!n.has(o))throw new V(`Extension Header Parameter "${o}" is not recognized`);if(void 0===a[o])throw new e(`Extension Header Parameter "${o}" is missing`);if(n.get(o)&&void 0===i[o])throw new e(`Extension Header Parameter "${o}" MUST be integrity protected`)}return new Set(i.crit)},tp=Symbol();class tu{constructor(e){if(!(e instanceof Uint8Array))throw TypeError("plaintext must be an instance of Uint8Array");this._plaintext=e}setKeyManagementParameters(e){if(this._keyManagementParameters)throw TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setSharedUnprotectedHeader(e){if(this._sharedUnprotectedHeader)throw TypeError("setSharedUnprotectedHeader can only be called once");return this._sharedUnprotectedHeader=e,this}setUnprotectedHeader(e){if(this._unprotectedHeader)throw TypeError("setUnprotectedHeader can only be called once");return this._unprotectedHeader=e,this}setAdditionalAuthenticatedData(e){return this._aad=e,this}setContentEncryptionKey(e){if(this._cek)throw TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw TypeError("setInitializationVector can only be called once");return this._iv=e,this}async encrypt(e,t){let r,i,n,o,s,c,l;if(!this._protectedHeader&&!this._unprotectedHeader&&!this._sharedUnprotectedHeader)throw new Q("either setProtectedHeader, setUnprotectedHeader, or sharedUnprotectedHeader must be called before #encrypt()");if(!tl(this._protectedHeader,this._unprotectedHeader,this._sharedUnprotectedHeader))throw new Q("JWE Protected, JWE Shared Unprotected and JWE Per-Recipient Header Parameter names must be disjoint");let d={...this._protectedHeader,...this._unprotectedHeader,...this._sharedUnprotectedHeader};if(td(Q,new Map,null==t?void 0:t.crit,this._protectedHeader,d),void 0!==d.zip){if(!this._protectedHeader||!this._protectedHeader.zip)throw new Q('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==d.zip)throw new V('Unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}let{alg:p,enc:u}=d;if("string"!=typeof p||!p)throw new Q('JWE "alg" (Algorithm) Header Parameter missing or invalid');if("string"!=typeof u||!u)throw new Q('JWE "enc" (Encryption Algorithm) Header Parameter missing or invalid');if("dir"===p){if(this._cek)throw TypeError("setContentEncryptionKey cannot be called when using Direct Encryption")}else if("ECDH-ES"===p&&this._cek)throw TypeError("setContentEncryptionKey cannot be called when using Direct Key Agreement");{let a;({cek:i,encryptedKey:r,parameters:a}=await tc(p,u,e,this._cek,this._keyManagementParameters)),a&&(t&&tp in t?this._unprotectedHeader?this._unprotectedHeader={...this._unprotectedHeader,...a}:this.setUnprotectedHeader(a):this._protectedHeader?this._protectedHeader={...this._protectedHeader,...a}:this.setProtectedHeader(a))}if(this._iv||(this._iv=et(u)),o=this._protectedHeader?D.encode(a(JSON.stringify(this._protectedHeader))):D.encode(""),this._aad?(s=a(this._aad),n=B(o,D.encode("."),D.encode(s))):n=o,"DEF"===d.zip){let e=await ((null==t?void 0:t.deflateRaw)||eS)(this._plaintext);({ciphertext:c,tag:l}=await eg(u,e,i,this._iv,n))}else({ciphertext:c,tag:l}=await eg(u,this._plaintext,i,this._iv,n));let h={ciphertext:a(c),iv:a(this._iv),tag:a(l)};return r&&(h.encrypted_key=a(r)),s&&(h.aad=s),this._protectedHeader&&(h.protected=W.decode(o)),this._sharedUnprotectedHeader&&(h.unprotected=this._sharedUnprotectedHeader),this._unprotectedHeader&&(h.header=this._unprotectedHeader),h}}class th{constructor(e){this._flattened=new tu(e)}setContentEncryptionKey(e){return this._flattened.setContentEncryptionKey(e),this}setInitializationVector(e){return this._flattened.setInitializationVector(e),this}setProtectedHeader(e){return this._flattened.setProtectedHeader(e),this}setKeyManagementParameters(e){return this._flattened.setKeyManagementParameters(e),this}async encrypt(e,t){let r=await this._flattened.encrypt(e,t);return[r.protected,r.encrypted_key,r.iv,r.ciphertext,r.tag].join(".")}}let tf=e=>Math.floor(e.getTime()/1e3);function ty(e){if("object"!=typeof e||null===e||"[object Object]"!==Object.prototype.toString.call(e))return!1;if(null===Object.getPrototypeOf(e))return!0;let t=e;for(;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}let tm=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i,tw=e=>{let t=tm.exec(e);if(!t)throw TypeError("Invalid time period format");let r=parseFloat(t[1]);switch(t[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(60*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(3600*r);case"day":case"days":case"d":return Math.round(86400*r);case"week":case"weeks":case"w":return Math.round(604800*r);default:return Math.round(0x1e187e0*r)}};class tg{constructor(e){if(!ty(e))throw TypeError("JWT Claims Set MUST be an object");this._payload=e}setIssuer(e){return this._payload={...this._payload,iss:e},this}setSubject(e){return this._payload={...this._payload,sub:e},this}setAudience(e){return this._payload={...this._payload,aud:e},this}setJti(e){return this._payload={...this._payload,jti:e},this}setNotBefore(e){return"number"==typeof e?this._payload={...this._payload,nbf:e}:this._payload={...this._payload,nbf:tf(new Date)+tw(e)},this}setExpirationTime(e){return"number"==typeof e?this._payload={...this._payload,exp:e}:this._payload={...this._payload,exp:tf(new Date)+tw(e)},this}setIssuedAt(e){return void 0===e?this._payload={...this._payload,iat:tf(new Date)}:this._payload={...this._payload,iat:e},this}}class tE extends tg{setProtectedHeader(e){if(this._protectedHeader)throw TypeError("setProtectedHeader can only be called once");return this._protectedHeader=e,this}setKeyManagementParameters(e){if(this._keyManagementParameters)throw TypeError("setKeyManagementParameters can only be called once");return this._keyManagementParameters=e,this}setContentEncryptionKey(e){if(this._cek)throw TypeError("setContentEncryptionKey can only be called once");return this._cek=e,this}setInitializationVector(e){if(this._iv)throw TypeError("setInitializationVector can only be called once");return this._iv=e,this}replicateIssuerAsHeader(){return this._replicateIssuerAsHeader=!0,this}replicateSubjectAsHeader(){return this._replicateSubjectAsHeader=!0,this}replicateAudienceAsHeader(){return this._replicateAudienceAsHeader=!0,this}async encrypt(e,t){let r=new th(D.encode(JSON.stringify(this._payload)));return this._replicateIssuerAsHeader&&(this._protectedHeader={...this._protectedHeader,iss:this._payload.iss}),this._replicateSubjectAsHeader&&(this._protectedHeader={...this._protectedHeader,sub:this._payload.sub}),this._replicateAudienceAsHeader&&(this._protectedHeader={...this._protectedHeader,aud:this._payload.aud}),r.setProtectedHeader(this._protectedHeader),this._iv&&r.setInitializationVector(this._iv),this._cek&&r.setContentEncryptionKey(this._cek),this._keyManagementParameters&&r.setKeyManagementParameters(this._keyManagementParameters),r.encrypt(e,t)}}let tb=K.Buffer.from([0]),t_=K.Buffer.from([2]),tA=K.Buffer.from([3]),tS=K.Buffer.from([48]),tv=K.Buffer.from([4]),tT=e=>{if(e<128)return K.Buffer.from([e]);let t=K.Buffer.alloc(5);t.writeUInt32BE(e,1);let r=1;for(;0===t[r];)r++;return t[r-1]=128|5-r,t.slice(r-1)},tR=new Map([["P-256",K.Buffer.from("06 08 2A 86 48 CE 3D 03 01 07".replace(/ /g,""),"hex")],["secp256k1",K.Buffer.from("06 05 2B 81 04 00 0A".replace(/ /g,""),"hex")],["P-384",K.Buffer.from("06 05 2B 81 04 00 22".replace(/ /g,""),"hex")],["P-521",K.Buffer.from("06 05 2B 81 04 00 23".replace(/ /g,""),"hex")],["ecPublicKey",K.Buffer.from("06 07 2A 86 48 CE 3D 02 01".replace(/ /g,""),"hex")],["X25519",K.Buffer.from("06 03 2B 65 6E".replace(/ /g,""),"hex")],["X448",K.Buffer.from("06 03 2B 65 6F".replace(/ /g,""),"hex")],["Ed25519",K.Buffer.from("06 03 2B 65 70".replace(/ /g,""),"hex")],["Ed448",K.Buffer.from("06 03 2B 65 71".replace(/ /g,""),"hex")]]);class tk{constructor(){this.length=0,this.elements=[]}oidFor(e){let t=tR.get(e);if(!t)throw new V("Invalid or unsupported OID");this.elements.push(t),this.length+=t.length}zero(){this.elements.push(t_,K.Buffer.from([1]),tb),this.length+=3}one(){this.elements.push(t_,K.Buffer.from([1]),K.Buffer.from([1])),this.length+=3}unsignedInteger(e){if(128&e[0]){let t=tT(e.length+1);this.elements.push(t_,t,tb,e),this.length+=2+t.length+e.length}else{let t=0;for(;0===e[t]&&(128&e[t+1])==0;)t++;let r=tT(e.length-t);this.elements.push(t_,tT(e.length-t),e.slice(t)),this.length+=1+r.length+e.length-t}}octStr(e){let t=tT(e.length);this.elements.push(tv,tT(e.length),e),this.length+=1+t.length+e.length}bitStr(e){let t=tT(e.length+1);this.elements.push(tA,tT(e.length+1),tb,e),this.length+=1+t.length+e.length+1}add(e){this.elements.push(e),this.length+=e.length}end(e=tS){let t=tT(this.length);return K.Buffer.concat([e,t,...this.elements],1+t.length+this.length)}}let tC=e=>{if(e9&&"oct"!==e.kty)return e.d?(0,k.createPrivateKey)({format:"jwk",key:e}):(0,k.createPublicKey)({format:"jwk",key:e});switch(e.kty){case"oct":return(0,k.createSecretKey)(G(e.k));case"RSA":{let t=new tk,r=void 0!==e.d,i=K.Buffer.from(e.n,"base64"),a=K.Buffer.from(e.e,"base64");r?(t.zero(),t.unsignedInteger(i),t.unsignedInteger(a),t.unsignedInteger(K.Buffer.from(e.d,"base64")),t.unsignedInteger(K.Buffer.from(e.p,"base64")),t.unsignedInteger(K.Buffer.from(e.q,"base64")),t.unsignedInteger(K.Buffer.from(e.dp,"base64")),t.unsignedInteger(K.Buffer.from(e.dq,"base64")),t.unsignedInteger(K.Buffer.from(e.qi,"base64"))):(t.unsignedInteger(i),t.unsignedInteger(a));let n={key:t.end(),format:"der",type:"pkcs1"},o=r?(0,k.createPrivateKey)(n):(0,k.createPublicKey)(n);return eq(o,i.length<<3),o}case"EC":{var t,r;let i=new tk,a=void 0!==e.d,n=K.Buffer.concat([K.Buffer.alloc(1,4),K.Buffer.from(e.x,"base64"),K.Buffer.from(e.y,"base64")]);if(a){i.zero();let r=new tk;r.oidFor("ecPublicKey"),r.oidFor(e.crv),i.add(r.end());let a=new tk;a.one(),a.octStr(K.Buffer.from(e.d,"base64"));let o=new tk;o.bitStr(n);let s=o.end(K.Buffer.from([161]));a.add(s);let c=a.end(),l=new tk;l.add(c);let d=l.end(K.Buffer.from([4]));i.add(d);let p=i.end(),u=(0,k.createPrivateKey)({key:p,format:"der",type:"pkcs8"});return t=e.crv,eP.set(u,t),u}let o=new tk;o.oidFor("ecPublicKey"),o.oidFor(e.crv),i.add(o.end()),i.bitStr(n);let s=i.end(),c=(0,k.createPublicKey)({key:s,format:"der",type:"spki"});return r=e.crv,eP.set(c,r),c}case"OKP":{let t=new tk;if(void 0!==e.d){t.zero();let r=new tk;r.oidFor(e.crv),t.add(r.end());let i=new tk;i.octStr(K.Buffer.from(e.d,"base64"));let a=i.end(K.Buffer.from([4]));t.add(a);let n=t.end();return(0,k.createPrivateKey)({key:n,format:"der",type:"pkcs8"})}let r=new tk;r.oidFor(e.crv),t.add(r.end()),t.bitStr(K.Buffer.from(e.x,"base64"));let i=t.end();return(0,k.createPublicKey)({key:i,format:"der",type:"spki"})}default:throw new V('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}};async function tO(e,t,r){var i;if(!ty(e))throw TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw TypeError('missing "k" (Key Value) Parameter value');if(null!=r||(r=!0!==e.ext),r)return tC({...e,alg:t,ext:null!=(i=e.ext)&&i});return G(e.k);case"RSA":if(void 0!==e.oth)throw new V('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return tC({...e,alg:t});default:throw new V('Unsupported "kty" (Key Type) Parameter value')}}async function tU(e,t,r,i,a){switch(ti(e,t,"decrypt"),e){case"dir":if(void 0!==r)throw new Q("Encountered unexpected JWE Encrypted Key");return t;case"ECDH-ES":if(void 0!==r)throw new Q("Encountered unexpected JWE Encrypted Key");case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":{let a,n;if(!ty(i.epk))throw new Q('JOSE Header "epk" (Ephemeral Public Key) missing or invalid');if(!eB(t))throw new V("ECDH with the provided key is not allowed or not supported by your javascript runtime");let o=await tO(i.epk,e);if(void 0!==i.apu){if("string"!=typeof i.apu)throw new Q('JOSE Header "apu" (Agreement PartyUInfo) invalid');try{a=G(i.apu)}catch{throw new Q("Failed to base64url decode the apu")}}if(void 0!==i.apv){if("string"!=typeof i.apv)throw new Q('JOSE Header "apv" (Agreement PartyVInfo) invalid');try{n=G(i.apv)}catch{throw new Q("Failed to base64url decode the apv")}}let s=await eD(o,t,"ECDH-ES"===e?i.enc:e,"ECDH-ES"===e?e2(i.enc):parseInt(e.slice(-5,-2),10),a,n);if("ECDH-ES"===e)return s;if(void 0===r)throw new Q("JWE Encrypted Key missing");return ek(e.slice(-6),s,r)}case"RSA1_5":case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":if(void 0===r)throw new Q("JWE Encrypted Key missing");return e1(e,t,r);case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":{let n;if(void 0===r)throw new Q("JWE Encrypted Key missing");if("number"!=typeof i.p2c)throw new Q('JOSE Header "p2c" (PBES2 Count) missing or invalid');let o=(null==a?void 0:a.maxPBES2Count)||1e4;if(i.p2c>o)throw new Q('JOSE Header "p2c" (PBES2 Count) out is of acceptable bounds');if("string"!=typeof i.p2s)throw new Q('JOSE Header "p2s" (PBES2 Salt) missing or invalid');try{n=G(i.p2s)}catch{throw new Q("Failed to base64url decode the p2s")}return eL(e,t,r,i.p2c,n)}case"A128KW":case"A192KW":case"A256KW":if(void 0===r)throw new Q("JWE Encrypted Key missing");return ek(e,t,r);case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":{let a,n;if(void 0===r)throw new Q("JWE Encrypted Key missing");if("string"!=typeof i.iv)throw new Q('JOSE Header "iv" (Initialization Vector) missing or invalid');if("string"!=typeof i.tag)throw new Q('JOSE Header "tag" (Authentication Tag) missing or invalid');try{a=G(i.iv)}catch{throw new Q("Failed to base64url decode the iv")}try{n=G(i.tag)}catch{throw new Q("Failed to base64url decode the tag")}return ts(e,t,r,a,n)}default:throw new V('Invalid or unsupported "alg" (JWE Algorithm) header value')}}let tx=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};async function tP(e,t,r){var i;let a,n,o,s,c,l,d;if(!ty(e))throw new Q("Flattened JWE must be an object");if(void 0===e.protected&&void 0===e.header&&void 0===e.unprotected)throw new Q("JOSE Header missing");if("string"!=typeof e.iv)throw new Q("JWE Initialization Vector missing or incorrect type");if("string"!=typeof e.ciphertext)throw new Q("JWE Ciphertext missing or incorrect type");if("string"!=typeof e.tag)throw new Q("JWE Authentication Tag missing or incorrect type");if(void 0!==e.protected&&"string"!=typeof e.protected)throw new Q("JWE Protected Header incorrect type");if(void 0!==e.encrypted_key&&"string"!=typeof e.encrypted_key)throw new Q("JWE Encrypted Key incorrect type");if(void 0!==e.aad&&"string"!=typeof e.aad)throw new Q("JWE AAD incorrect type");if(void 0!==e.header&&!ty(e.header))throw new Q("JWE Shared Unprotected Header incorrect type");if(void 0!==e.unprotected&&!ty(e.unprotected))throw new Q("JWE Per-Recipient Unprotected Header incorrect type");if(e.protected)try{let t=G(e.protected);a=JSON.parse(W.decode(t))}catch{throw new Q("JWE Protected Header is invalid")}if(!tl(a,e.header,e.unprotected))throw new Q("JWE Protected, JWE Unprotected Header, and JWE Per-Recipient Unprotected Header Parameter names must be disjoint");let p={...a,...e.header,...e.unprotected};if(td(Q,new Map,null==r?void 0:r.crit,a,p),void 0!==p.zip){if(!a||!a.zip)throw new Q('JWE "zip" (Compression Algorithm) Header MUST be integrity protected');if("DEF"!==p.zip)throw new V('Unsupported JWE "zip" (Compression Algorithm) Header Parameter value')}let{alg:u,enc:h}=p;if("string"!=typeof u||!u)throw new Q("missing JWE Algorithm (alg) in JWE Header");if("string"!=typeof h||!h)throw new Q("missing JWE Encryption Algorithm (enc) in JWE Header");let f=r&&tx("keyManagementAlgorithms",r.keyManagementAlgorithms),y=r&&tx("contentEncryptionAlgorithms",r.contentEncryptionAlgorithms);if(f&&!f.has(u))throw new q('"alg" (Algorithm) Header Parameter not allowed');if(y&&!y.has(h))throw new q('"enc" (Encryption Algorithm) Header Parameter not allowed');if(void 0!==e.encrypted_key)try{n=G(e.encrypted_key)}catch{throw new Q("Failed to base64url decode the encrypted_key")}let m=!1;"function"==typeof t&&(t=await t(a,e),m=!0);try{o=await tU(u,t,n,p,r)}catch(e){if(e instanceof TypeError||e instanceof Q||e instanceof V)throw e;o=e8(h)}try{s=G(e.iv)}catch{throw new Q("Failed to base64url decode the iv")}try{c=G(e.tag)}catch{throw new Q("Failed to base64url decode the tag")}let w=D.encode(null!=(i=e.protected)?i:"");l=void 0!==e.aad?B(w,D.encode("."),D.encode(e.aad)):w;try{d=G(e.ciphertext)}catch{throw new Q("Failed to base64url decode the ciphertext")}let g=await tn(h,o,d,s,c,l);"DEF"===p.zip&&(g=await ((null==r?void 0:r.inflateRaw)||eA)(g));let E={plaintext:g};if(void 0!==e.protected&&(E.protectedHeader=a),void 0!==e.aad)try{E.additionalAuthenticatedData=G(e.aad)}catch{throw new Q("Failed to base64url decode the aad")}return(void 0!==e.unprotected&&(E.sharedUnprotectedHeader=e.unprotected),void 0!==e.header&&(E.unprotectedHeader=e.header),m)?{...E,key:t}:E}async function tH(e,t,r){if(e instanceof Uint8Array&&(e=W.decode(e)),"string"!=typeof e)throw new Q("Compact JWE must be a string or Uint8Array");let{0:i,1:a,2:n,3:o,4:s,length:c}=e.split(".");if(5!==c)throw new Q("Invalid Compact JWE");let l=await tP({ciphertext:o,iv:n||void 0,protected:i||void 0,tag:s||void 0,encrypted_key:a||void 0},t,r),d={plaintext:l.plaintext,protectedHeader:l.protectedHeader};return"function"==typeof t?{...d,key:l.key}:d}let tK=e=>e.toLowerCase().replace(/^application\//,""),tI=(e,t)=>"string"==typeof e?t.includes(e):!!Array.isArray(e)&&t.some(Set.prototype.has.bind(new Set(e))),tD=(e,t,r={})=>{let i,a,{typ:n}=r;if(n&&("string"!=typeof e.typ||tK(e.typ)!==tK(n)))throw new F('unexpected "typ" JWT header value',"typ","check_failed");try{i=JSON.parse(W.decode(t))}catch{}if(!ty(i))throw new Z("JWT Claims Set must be a top-level JSON object");let{requiredClaims:o=[],issuer:s,subject:c,audience:l,maxTokenAge:d}=r;for(let e of(void 0!==d&&o.push("iat"),void 0!==l&&o.push("aud"),void 0!==c&&o.push("sub"),void 0!==s&&o.push("iss"),new Set(o.reverse())))if(!(e in i))throw new F(`missing required "${e}" claim`,e,"missing");if(s&&!(Array.isArray(s)?s:[s]).includes(i.iss))throw new F('unexpected "iss" claim value',"iss","check_failed");if(c&&i.sub!==c)throw new F('unexpected "sub" claim value',"sub","check_failed");if(l&&!tI(i.aud,"string"==typeof l?[l]:l))throw new F('unexpected "aud" claim value',"aud","check_failed");switch(typeof r.clockTolerance){case"string":a=tw(r.clockTolerance);break;case"number":a=r.clockTolerance;break;case"undefined":a=0;break;default:throw TypeError("Invalid clockTolerance option type")}let{currentDate:p}=r,u=tf(p||new Date);if((void 0!==i.iat||d)&&"number"!=typeof i.iat)throw new F('"iat" claim must be a number',"iat","invalid");if(void 0!==i.nbf){if("number"!=typeof i.nbf)throw new F('"nbf" claim must be a number',"nbf","invalid");if(i.nbf>u+a)throw new F('"nbf" claim timestamp check failed',"nbf","check_failed")}if(void 0!==i.exp){if("number"!=typeof i.exp)throw new F('"exp" claim must be a number',"exp","invalid");if(i.exp<=u-a)throw new z('"exp" claim timestamp check failed',"exp","check_failed")}if(d){let e=u-i.iat;if(e-a>("number"==typeof d?d:tw(d)))throw new z('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(e<0-a)throw new F('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return i};async function tW(e,t,r){let i=await tH(e,t,r),a=tD(i.protectedHeader,i.plaintext,r),{protectedHeader:n}=i;if(void 0!==n.iss&&n.iss!==a.iss)throw new F('replicated "iss" claim header parameter mismatch',"iss","mismatch");if(void 0!==n.sub&&n.sub!==a.sub)throw new F('replicated "sub" claim header parameter mismatch',"sub","mismatch");if(void 0!==n.aud&&JSON.stringify(n.aud)!==JSON.stringify(a.aud))throw new F('replicated "aud" claim header parameter mismatch',"aud","mismatch");let o={payload:a,protectedHeader:n};return"function"==typeof t?{...o,key:i.key}:o}let tB={randomUUID:C().randomUUID},tM=new Uint8Array(256),tJ=tM.length,t$=[];for(let e=0;e<256;++e)t$.push((e+256).toString(16).slice(1));let tj=function(e,t,r){if(tB.randomUUID&&!t&&!e)return tB.randomUUID();let i=(e=e||{}).random||(e.rng||function(){return tJ>tM.length-16&&(C().randomFillSync(tM),tJ=0),tM.slice(tJ,tJ+=16)})();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=i[e];return t}return function(e,t=0){return t$[e[t+0]]+t$[e[t+1]]+t$[e[t+2]]+t$[e[t+3]]+"-"+t$[e[t+4]]+t$[e[t+5]]+"-"+t$[e[t+6]]+t$[e[t+7]]+"-"+t$[e[t+8]]+t$[e[t+9]]+"-"+t$[e[t+10]]+t$[e[t+11]]+t$[e[t+12]]+t$[e[t+13]]+t$[e[t+14]]+t$[e[t+15]]}(i)},tL=["image/jpeg","image/png","image/gif","image/webp","image/svg+xml","image/tiff","image/bmp","image/x-icon"];async function tG(e){let t=globalThis._EDGE_STORE_LOGGER,{ctx:r,provider:i,router:a}=e;t.debug("Running [init]",{ctx:r});let n=await tY(r),{token:o}=await i.init({ctx:r,router:a}),s=[(0,H.l)("edgestore-ctx",n,{path:"/",maxAge:2592e3})];o&&s.push((0,H.l)("edgestore-token",o,{path:"/",maxAge:2592e3}));let c=await i.getBaseUrl();return t.debug("Finished [init]",{ctx:r,newCookies:s,token:o,baseUrl:c}),{newCookies:s,token:o,baseUrl:c}}async function tN(e){var t;let{provider:r,router:i,ctxToken:a,body:{bucketName:n,input:o,fileInfo:s}}=e,c=globalThis._EDGE_STORE_LOGGER;if(c.debug("Running [requestUpload]",{bucketName:n,input:o,fileInfo:s}),!a)throw new h({message:"Missing edgestore-ctx cookie",code:"UNAUTHORIZED"});let l=await tZ(a);c.debug("Decrypted Context",{ctx:l});let d=i.buckets[n];if(!d)throw new h({message:`Bucket ${n} not found`,code:"BAD_REQUEST"});if(d._def.beforeUpload){c.debug("Running [beforeUpload]");let e=await d._def.beforeUpload?.({ctx:l,input:o,fileInfo:{size:s.size,type:s.type,fileName:s.fileName,extension:s.extension,replaceTargetUrl:s.replaceTargetUrl,temporary:s.temporary}});if(c.debug("Finished [beforeUpload]",{canUpload:e}),!e)throw new h({message:"Upload not allowed for the current context",code:"UPLOAD_NOT_ALLOWED"})}if("IMAGE"===d._def.type&&!tL.includes(s.type))throw new h({code:"MIME_TYPE_NOT_ALLOWED",message:"Only images are allowed in this bucket",details:{allowedMimeTypes:tL,mimeType:s.type}});if(d._def.bucketConfig?.maxSize&&s.size>d._def.bucketConfig.maxSize)throw new h({code:"FILE_TOO_LARGE",message:`File size is too big. Max size is ${d._def.bucketConfig.maxSize}`,details:{maxFileSize:d._def.bucketConfig.maxSize,fileSize:s.size}});if(d._def.bucketConfig?.accept){let e=d._def.bucketConfig.accept,t=!1;for(let r of e)if(r.endsWith("/*")){let e=r.replace("/*","");if(s.type.startsWith(e)){t=!0;break}}else if(s.type===r){t=!0;break}if(!t)throw new h({code:"MIME_TYPE_NOT_ALLOWED",message:`"${s.type}" is not allowed. Accepted types are ${JSON.stringify(e)}`,details:{allowedMimeTypes:e,mimeType:s.type}})}let p=function(e){let{bucket:t}=e,r=t._def.path;return r.map(t=>{let i=Object.entries(t);if(void 0===i[0])throw new h({message:`Empty path param found in: ${JSON.stringify(r)}`,code:"SERVER_ERROR"});let[a,n]=i[0];return{key:a,value:n().split(".").reduce((e,t)=>{if(void 0===e[t])throw new h({message:`Missing key ${t} in ${JSON.stringify(e)}`,code:"BAD_REQUEST"});return e[t]},e.pathAttrs)}})}({fileInfo:s,bucket:d,pathAttrs:{ctx:l,input:o}}),u=await d._def.metadata?.({ctx:l,input:o}),f=void 0===d._def.accessControl;c.debug("upload info",{path:p,metadata:u,isPublic:f,bucketType:d._def.type});let y=await r.requestUpload({bucketName:n,bucketType:d._def.type,fileInfo:{...s,path:p,isPublic:f,metadata:u}}),{parsedPath:m,pathOrder:w}={parsedPath:(t=p).reduce((e,t)=>(e[t.key]=t.value,e),{}),pathOrder:t.map(e=>e.key)};return c.debug("Finished [requestUpload]"),{...y,size:s.size,uploadedAt:new Date().toISOString(),path:m,pathOrder:w,metadata:u}}async function tF(e){let{provider:t,ctxToken:r,body:{multipart:i,path:a}}=e,n=globalThis._EDGE_STORE_LOGGER;if(n.debug("Running [requestUploadParts]",{multipart:i,path:a}),!r)throw new h({message:"Missing edgestore-ctx cookie",code:"UNAUTHORIZED"});await tZ(r);let o=await t.requestUploadParts({multipart:i,path:a});return n.debug("Finished [requestUploadParts]"),o}async function tz(e){let{provider:t,router:r,ctxToken:i,body:{bucketName:a,uploadId:n,key:o,parts:s}}=e,c=globalThis._EDGE_STORE_LOGGER;if(c.debug("Running [completeMultipartUpload]",{bucketName:a,uploadId:n,key:o}),!i)throw new h({message:"Missing edgestore-ctx cookie",code:"UNAUTHORIZED"});if(await tZ(i),!r.buckets[a])throw new h({message:`Bucket ${a} not found`,code:"BAD_REQUEST"});let l=await t.completeMultipartUpload({uploadId:n,key:o,parts:s});return c.debug("Finished [completeMultipartUpload]"),l}async function tq(e){let{provider:t,router:r,ctxToken:i,body:{bucketName:a,url:n}}=e,o=globalThis._EDGE_STORE_LOGGER;if(o.debug("Running [confirmUpload]",{bucketName:a,url:n}),!i)throw new h({message:"Missing edgestore-ctx cookie",code:"UNAUTHORIZED"});await tZ(i);let s=r.buckets[a];if(!s)throw new h({message:`Bucket ${a} not found`,code:"BAD_REQUEST"});let c=await t.confirmUpload({bucket:s,url:n});return o.debug("Finished [confirmUpload]"),c}async function tV(e){let{provider:t,router:r,ctxToken:i,body:{bucketName:a,url:n}}=e,o=globalThis._EDGE_STORE_LOGGER;if(o.debug("Running [deleteFile]",{bucketName:a,url:n}),!i)throw new h({message:"Missing edgestore-ctx cookie",code:"UNAUTHORIZED"});let s=await tZ(i),c=r.buckets[a];if(!c)throw new h({message:`Bucket ${a} not found`,code:"BAD_REQUEST"});if(!c._def.beforeDelete)throw new h({message:"You need to define beforeDelete if you want to delete files directly from the frontend.",code:"SERVER_ERROR"});let l=await t.getFile({url:n});if(!await c._def.beforeDelete({ctx:s,fileInfo:l}))throw new h({message:"Delete not allowed for the current context",code:"DELETE_NOT_ALLOWED"});let d=await t.deleteFile({bucket:c,url:n});return o.debug("Finished [deleteFile]"),d}async function tY(e){let t=process.env.EDGE_STORE_JWT_SECRET??process.env.EDGE_STORE_SECRET_KEY;if(!t)throw new h({message:"EDGE_STORE_JWT_SECRET or EDGE_STORE_SECRET_KEY is not defined",code:"SERVER_ERROR"});let r=await tQ(t);return await new tE(e).setProtectedHeader({alg:"dir",enc:"A256GCM"}).setIssuedAt().setExpirationTime(Date.now()/1e3+2592e3).setJti(tj()).encrypt(r)}async function tX(e){let t=process.env.EDGE_STORE_JWT_SECRET??process.env.EDGE_STORE_SECRET_KEY;if(!t)throw new h({message:"EDGE_STORE_JWT_SECRET or EDGE_STORE_SECRET_KEY is not defined",code:"SERVER_ERROR"});let r=await tQ(t),{payload:i}=await tW(e,r,{clockTolerance:15});return i}async function tQ(e){return await P("sha256",e,"","Edge Store Generated Encryption Key",32)}async function tZ(e){return await tX(e)}let t0=g.create(),t1=function(e){let{provider:t=function(e){let{accessKey:t=process.env.EDGE_STORE_ACCESS_KEY,secretKey:r=process.env.EDGE_STORE_SECRET_KEY}=(void 0)??{},i=process.env.EDGE_STORE_BASE_URL??"https://files.edgestore.dev";if(!t||!r)throw new S;let a=function(e){let{accessKey:t=process.env.EDGE_STORE_ACCESS_KEY,secretKey:r=process.env.EDGE_STORE_SECRET_KEY}=e??{};if(!t||!r)throw new S;return{getToken:async e=>await R.getToken({accessKey:t,secretKey:r,ctx:e.ctx,router:e.router}),getFile:async({url:e})=>await R.getFile({accessKey:t,secretKey:r,url:e}),requestUpload:async({bucketName:e,bucketType:i,fileInfo:a,multipart:n})=>await R.requestUpload({accessKey:t,secretKey:r,bucketName:e,bucketType:i,fileInfo:a,multipart:n}),requestUploadParts:async({key:e,multipart:i})=>await R.requestUploadParts({accessKey:t,secretKey:r,key:e,multipart:i}),completeMultipartUpload:async({uploadId:e,key:i,parts:a})=>await R.completeMultipartUpload({accessKey:t,secretKey:r,uploadId:e,key:i,parts:a}),confirmUpload:async({url:e})=>await R.confirmUpload({accessKey:t,secretKey:r,url:e}),deleteFile:async({url:e})=>await R.deleteFile({accessKey:t,secretKey:r,url:e}),listFiles:async e=>await R.listFiles({accessKey:t,secretKey:r,...e})}}({accessKey:t,secretKey:r});return{init:async({ctx:e,router:t})=>({token:await a.getToken({ctx:e,router:t})}),getBaseUrl:()=>i,getFile:async({url:e})=>{let{uploadedAt:t,...r}=await a.getFile({url:e});return{uploadedAt:new Date(t),...r}},async requestUpload({bucketName:e,bucketType:t,fileInfo:r}){let i=5242880;if(r.size>0xa00000){let n=Math.ceil(r.size/i);n>1e3&&(n=1e3,i=Math.ceil(r.size/n));let o=await a.requestUpload({bucketName:e,bucketType:t,fileInfo:r,multipart:{parts:Array.from({length:n}).map((e,t)=>t+1)}}),s=o.multipart?{key:o.multipart.key,uploadId:o.multipart.uploadId,parts:o.multipart.parts.map(e=>({partNumber:e.partNumber,uploadUrl:e.signedUrl})),partSize:i,totalParts:n}:void 0;if(s)return{accessUrl:o.accessUrl,thumbnailUrl:o.thumbnailUrl,multipart:s};if(o.signedUrl)return{accessUrl:o.accessUrl,uploadUrl:o.signedUrl,thumbnailUrl:o.thumbnailUrl};throw new h({message:"Could not get upload url",code:"SERVER_ERROR"})}let n=await a.requestUpload({bucketName:e,bucketType:t,fileInfo:r});if(n.signedUrl)return{accessUrl:n.accessUrl,uploadUrl:n.signedUrl,thumbnailUrl:n.thumbnailUrl};throw new h({message:"Could not get upload url",code:"SERVER_ERROR"})},requestUploadParts:async({multipart:e,path:t})=>{let r=await a.requestUploadParts({multipart:e,key:t});return{multipart:{uploadId:r.multipart.uploadId,parts:r.multipart.parts.map(e=>({partNumber:e.partNumber,uploadUrl:e.signedUrl}))}}},completeMultipartUpload:async({uploadId:e,key:t,parts:r})=>await a.completeMultipartUpload({uploadId:e,key:t,parts:r}),confirmUpload:async({url:e})=>await a.confirmUpload({url:e}),deleteFile:async({url:e})=>await a.deleteFile({url:e})}}()}=e,r=new b(e.logLevel);return globalThis._EDGE_STORE_LOGGER=r,r.debug("Creating Edge Store Next handler (app adapter)"),async i=>{try{if(!("nextUrl"in i))throw new h({message:"Error running the app adapter. Make sure you are importing the correct adapter in your router configuration",code:"SERVER_ERROR"});let r=i.nextUrl.pathname;if(_(r,"/health"))return new Response("OK",{status:200});if(_(r,"/init")){let r={};try{r="createContext"in e?await e.createContext({req:i}):{}}catch(e){throw new h({message:"Error creating context",code:"CREATE_CONTEXT_ERROR",cause:e instanceof Error?e:void 0})}let{newCookies:a,token:n,baseUrl:o}=await tG({ctx:r,provider:t,router:e.router}),s=new Response(JSON.stringify({token:n,baseUrl:o}),{status:200,headers:{"Content-Type":"application/json"}});for(let e of a)s.headers.append("Set-Cookie",e);return s}if(_(r,"/request-upload")){let r=await tN({provider:t,router:e.router,body:await i.json(),ctxToken:i.cookies.get("edgestore-ctx")?.value});return new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}else if(_(r,"/request-upload-parts")){let r=await tF({provider:t,router:e.router,body:await i.json(),ctxToken:i.cookies.get("edgestore-ctx")?.value});return new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}else if(_(r,"/complete-multipart-upload"))return await tz({provider:t,router:e.router,body:await i.json(),ctxToken:i.cookies.get("edgestore-ctx")?.value}),new Response(null,{status:200});else if(_(r,"/confirm-upload")){let r=await tq({provider:t,router:e.router,body:await i.json(),ctxToken:i.cookies.get("edgestore-ctx")?.value});return new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}else if(_(r,"/delete-file")){let r=await tV({provider:t,router:e.router,body:await i.json(),ctxToken:i.cookies.get("edgestore-ctx")?.value});return new Response(JSON.stringify(r),{status:200,headers:{"Content-Type":"application/json"}})}else{if(!_(r,"/proxy-file"))return new Response(null,{status:404});let e=i.nextUrl.searchParams.get("url");if("string"!=typeof e)return new Response(null,{status:400});{let t=await fetch(e,{headers:{cookie:i.cookies.toString()??""}}),r=await t.arrayBuffer();return new Response(r,{status:t.status,headers:{"Content-Type":t.headers.get("Content-Type")??"application/octet-stream"}})}}}catch(e){if(e instanceof h)return r[e.level](e.formattedMessage()),e.cause&&r[e.level](e.cause),new Response(JSON.stringify(e.formattedJson()),{status:u[e.code],headers:{"Content-Type":"application/json"}});return r.error(e),new Response(JSON.stringify(new h({message:"Internal server error",code:"SERVER_ERROR"}).formattedJson()),{status:500,headers:{"Content-Type":"application/json"}})}}}({router:t0.router({publicFiles:t0.fileBucket()})}),t2=new s.AppRouteRouteModule({definition:{kind:c.RouteKind.APP_ROUTE,page:"/api/edgestore/[...edgestore]/route",pathname:"/api/edgestore/[...edgestore]",filename:"route",bundlePath:"app/api/edgestore/[...edgestore]/route"},resolvedPagePath:"C:\\Users\\Russell\\Downloads\\AI-Projects\\Mesza\\mesza-app\\app\\api\\edgestore\\[...edgestore]\\route.ts",nextConfigOutput:"",userland:o}),{workAsyncStorage:t8,workUnitAsyncStorage:t4,serverHooks:t6}=t2;function t5(){return(0,l.patchFetch)({workAsyncStorage:t8,workUnitAsyncStorage:t4})}},19678:(e,t,r)=>{"use strict";e.exports=r(44870)},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},42454:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},93807:(e,t)=>{"use strict";t.l=function(e,t,a){var o=a||{},s=o.encode||n;if("function"!=typeof s)throw TypeError("option encode is invalid");if(!i.test(e))throw TypeError("argument name is invalid");var c=s(t);if(c&&!i.test(c))throw TypeError("argument val is invalid");var l=e+"="+c;if(null!=o.maxAge){var d=o.maxAge-0;if(isNaN(d)||!isFinite(d))throw TypeError("option maxAge is invalid");l+="; Max-Age="+Math.floor(d)}if(o.domain){if(!i.test(o.domain))throw TypeError("option domain is invalid");l+="; Domain="+o.domain}if(o.path){if(!i.test(o.path))throw TypeError("option path is invalid");l+="; Path="+o.path}if(o.expires){var p,u=o.expires;if(p=u,"[object Date]"!==r.call(p)&&!(p instanceof Date)||isNaN(u.valueOf()))throw TypeError("option expires is invalid");l+="; Expires="+u.toUTCString()}if(o.httpOnly&&(l+="; HttpOnly"),o.secure&&(l+="; Secure"),o.priority)switch("string"==typeof o.priority?o.priority.toLowerCase():o.priority){case"low":l+="; Priority=Low";break;case"medium":l+="; Priority=Medium";break;case"high":l+="; Priority=High";break;default:throw TypeError("option priority is invalid")}if(o.sameSite)switch("string"==typeof o.sameSite?o.sameSite.toLowerCase():o.sameSite){case!0:case"strict":l+="; SameSite=Strict";break;case"lax":l+="; SameSite=Lax";break;case"none":l+="; SameSite=None";break;default:throw TypeError("option sameSite is invalid")}return l};var r=Object.prototype.toString,i=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function a(e){return -1!==e.indexOf("%")?decodeURIComponent(e):e}function n(e){return encodeURIComponent(e)}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[6862,1201],()=>r(19116));module.exports=i})();